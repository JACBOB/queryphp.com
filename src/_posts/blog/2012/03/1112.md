title: thinkphp的视图替换功能有设计缺陷
date: 2012-03-31 15:20:39
---

THINKPHP视图替换在最后生成的HTML结果中进行替换：<br/>PHP代码<br/>    protected function templateContentReplace($content) {<br/>        // 系统默认的特殊变量替换<br/>        $replace =  array(<br/>            '__TMPL__'      => APP_TMPL_PATH,  // 项目模板目录<br/>            '__ROOT__'      => __ROOT__,       // 当前网站地址<br/>            '__APP__'       => __APP__,        // 当前项目地址<br/>            '__GROUP__'   =>   defined('GROUP_NAME')?__GROUP__:__APP__,<br/>            '__ACTION__'    => __ACTION__,     // 当前操作地址<br/>            '__SELF__'      => __SELF__,       // 当前页面地址<br/>            '__URL__'       => __URL__,<br/>            '../Public'   => APP_TMPL_PATH.'Public',// 项目公共模板目录<br/>            '__PUBLIC__'  => __ROOT__.'/Public',// 站点公共目录<br/>        );<br/>        // 允许用户自定义模板的字符串替换<br/>        if(is_array(C('TMPL_PARSE_STRING')) )<br/>            $replace =  array_merge($replace,C('TMPL_PARSE_STRING'));<br/>        $content = str_replace(array_keys($replace),array_values($replace),$content);<br/>        return $content;<br/>    }<br/>这样会出现这种情况：<br/>PHP代码<br/>        public function index(){<br/>                $s='asdasdasd__URL_asdddddddddd___URL__sddddddddddd';<br/>                $this->assign('s',$s);<br/>                $this->display();<br/>        }<br/>这个$s变量中内容最后也被替换了<br/>asdasdasd__URL_asdddddddddd_/think/index.php/Indexsddddddddddd<br/><br/><br/>比如，做一个模板后台编辑前台的模板，也就是在线编辑风格文件的时候，相应的主题文件的中路径也会被替换成后台的路径，那么就会出现错误和无法迁移。。。，相当麻烦啦<br/><br/><br/>我觉得这个地方应该在模板编译的时候进行替换，这样不用修改模板，又保持了模板独立性：<br/>    protected function templateContentReplace($content) {<br/>        // 系统默认的特殊变量替换<br/>        $replace =  array(<br/>            '__TMPL__'      => '<?php echo APP_TMPL_PATH;?>',  // 项目模板目录<br/>这样就可以不破坏变量中的东西了。