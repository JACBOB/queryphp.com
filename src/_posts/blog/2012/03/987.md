title: 关于DiscuzX2插件设计与hook标签
date: 2012-03-10 14:25:39
---

<p>
	转：<a href="http://www.eamonning.com/blog.php?id=278">http://www.eamonning.com/blog.php?id=278</a>
</p>
<p>
	不知道为什么，发现Discuz的页面中莫名其妙的多了以下变量，就是直接显示在页面上的。
</p>
<p>
	[string&nbsp;global_usernav_extra1]
</p>
<p>
	[string&nbsp;global_usernav_extra2]
</p>
<p>
	[string&nbsp;global_usernav_extra3]
</p>
<p>
	[string&nbsp;global_cpnav_extra2]
</p>
<p>
	[string&nbsp;global_header]
</p>
<p>
	[string&nbsp;global_footer]
</p>
<p>
	[string&nbsp;global_footerlink]
</p>
<p>
	查看源代码，发现这些代码都是&lt;hook&gt;&lt;/hook&gt;这样的标签，起初还以为是discuz缓存，没有将这些模板变量替换掉，或者是页面执行完之后调用js替换掉真实的模板变量，后来发现怎么清楚缓存设置什么的都没有用。
</p>
<p>
	无奈翻翻代码，发现在template类中的这个函数：
</p>
<p>
	function&nbsp;hooktags($hookid,&nbsp;$key&nbsp;=&nbsp;'')&nbsp;{
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;$_G;
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;$i&nbsp;=&nbsp;count($this-&gt;replacecode['search']);
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;replacecode['search'][$i]&nbsp;=&nbsp;$search&nbsp;=&nbsp;"&lt;!--HOOK_TAG_$i--&gt;";
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;$key&nbsp;=&nbsp;$key&nbsp;!==&nbsp;''&nbsp;?&nbsp;"[$key]"&nbsp;:&nbsp;'';
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;$dev&nbsp;=&nbsp;'';
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;if(isset($_G['config']['plugindeveloper'])&nbsp;&amp;&amp;&nbsp;$_G['config']['plugindeveloper']&nbsp;==&nbsp;2)&nbsp;{
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$dev&nbsp;=&nbsp;"echo&nbsp;'&lt;hook&gt;[".($key&nbsp;?&nbsp;'array'&nbsp;:&nbsp;'string')."&nbsp;$hookid]&lt;/hook&gt;';";
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;}
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;replacecode['replace'][$i]&nbsp;=&nbsp;"&lt;?php&nbsp;{$dev}if(!empty($_G['setting']['pluginhooks']['$hookid']$key))&nbsp;echo&nbsp;$_G['setting']['pluginhooks']['$hookid']$key;?&gt;";
</p>
<p>
	&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$search;
</p>
<p>
	}
</p>
<p>
	注意红色的那句，原来如此，也终于知道了原因。因为我把插件设计模式设置为了2，也就是下面所示
</p>
<p>
	config/config_global.php
</p>
<p>
	$_config['plugindeveloper']&nbsp;=&nbsp;2;&nbsp;&nbsp;&nbsp;//&nbsp;1&nbsp;表示开启插件设计者模式&nbsp;；&nbsp;2&nbsp;表示开启插件设计者模式且显示前台页面的潜入点
</p>
<p>
	看来写代码有时候还真烦人呀。这是我在discuz中的提问，刚开始没人回答，后来还是自己找到了原因，可这时候却莫名其妙的有人回复了，不过还是谢谢啦。
</p>
<p>
	http://www.discuz.net/forum.php?mod=viewthread&amp;tid=2571635
</p>